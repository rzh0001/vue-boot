<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.pay.mapper.OrderInfoEntityMapper">
    <select id="queryOrderByOuterOrderId" resultType="String" parameterType="String">
        SELECT
            order_id
        FROM
            pay_order_info
        WHERE
            outer_order_id = #{outerOrderId}
    </select>
    <select id="queryOrderByOrderId"  parameterType="String" resultType="org.jeecg.modules.pay.entity.OrderInfoEntity">
        select
          *
        from
          pay_order_info
        where
          order_id = #{orderId}
    </select>
    <select id="getUserTodaySummary" resultType="Map" parameterType="Map">
        SELECT order_id
        FROM pay_order_info
        WHERE outer_order_id = #{outerOrderId}
    </select>
    <select id="summary" parameterType="Map" resultType="Map">
        select user_id,user_name,user_realname,
        count(1) as totalOrderCount,sum(submit_amount) as totalOrderAmount,
        count( case when status = 2 || status = 1 then 1 else null end) as paidOrderCount,
        sum( case when status = 2 || status = 1 then submit_amount else 0 end) as paidOrderAmount,
        count( case when status != 2 || status != 1 then 1 else null end) as unpaidOrderCount,
        sum( case when status != 2 || status != 1 then submit_amount else 0 end) as unpaidOrderAmount,
        sum(case when status = 2 then poundage else 0 end) as feeIncome
        from pay_order_info
        where to_days(success_time) = to_days(#{map.date})

        <if test="map.username!=null and map.username!=''">
            and user_name = #{map.username}
        </if>
        <if test="map.userRealname!=null and map.userRealname!=''">
            and user_realname = #{map.userRealname}
        </if>
        <if test="map.agentId!=null and map.agentId!=''">
            and agent_id = #{map.agentId}
        </if>
        <if test="map.salesmanId!=null and map.salesmanId!=''">
            and salesman_Id = #{map.salesmanId}
        </if>
        <if test="map.userId!=null and map.userId!=''">
            and user_id = #{map.userId}
        </if>
        <if test="map.username!=null and map.username!=''">
            and user_name = #{map.username}
        </if>
        group by user_id,user_name,user_realname

    </select>

    <update id="updateOrderStatusSuccessByOrderId" parameterType="String">
        UPDATE pay_order_info
        SET `status` = 2,update_time=NOW(),success_time=NOW()
        WHERE
            order_id = #{orderId}
    </update>
    <update id="updateOrderStatusNoBackByOrderId" parameterType="String">
        UPDATE pay_order_info
        SET `status` = 1,update_time=NOW(),success_time=NOW()
        WHERE
            order_id = #{orderId}
    </update>
</mapper>